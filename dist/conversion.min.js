!function(t,n){"object"==typeof exports&&"undefined"!=typeof module?module.exports=n():"function"==typeof define&&define.amd?define(n):t.Conversion=n()}(this,function(){"use strict";var e={containerToInsert:".js-content-insert",containerToSearchLinks:"body",disableAttribute:"data-ajax-disabled",saveBack:!0,scrollToTop:!0};function i(t,n){return Object.assign({},t,n)}function o(t){return"function"==typeof t}function a(t){console.error("conversion.js: "+t)}var s=function(t,n){if(!(t instanceof n))throw new TypeError("Cannot call a class as a function")},r=function(){function i(t,n){for(var e=0;e<n.length;e++){var i=n[e];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(t,n,e){return n&&i(t.prototype,n),e&&i(t,e),t}}(),l=function(){function t(){s(this,t),this.events={}}return r(t,[{key:"on",value:function(t,n){o(n)?this.events[t]=n:a("event handler isn't a function")}},{key:"emit",value:function(t){var n=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};return this.events[t]?o(this.events[t])?void this.events[t](n):(a("handler for "+t+" event isn't a function"),null):null}}]),t}();return function(){function n(t){s(this,n),this.options=i(e,t),this.disabled=!1,this.links=[],this.oldLinks=[window.location.href],this._eventBus=new l,this._isBack=!1,this._hostName=window.location.hostname,this._dom={},this._isDisableAjax=this._isDisableAjax.bind(this),this._handleLink=this._handleLink.bind(this),this._handleLinkClick=this._handleLinkClick.bind(this),this._getContentSuccess=this._getContentSuccess.bind(this),this._getContentSuccess=this._getContentSuccess.bind(this),this._getContentFail=this._getContentFail.bind(this)}return r(n,[{key:"init",value:function(){this._dom=this._initDom(),this._initLinks(),this.options.saveBack&&this._initWindowPopStateHandler(),this._eventBus.emit("init.finished")}},{key:"update",value:function(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};this.options=i(e,t)}},{key:"on",value:function(t,n){this._eventBus.on(t,n)}},{key:"disable",value:function(){this.disabled=!0}},{key:"enable",value:function(){this.disabled=!1}},{key:"_initDom",value:function(){var t={};return t.body=document.getElementsByTagName("body")[0],t.containerToSearchLinks=document.querySelector(this.options.containerToSearchLinks),t.containerToInsert=document.querySelector(this.options.containerToInsert),t}},{key:"_initLinks",value:function(){if(this.links=this._dom.containerToSearchLinks.getElementsByTagName("a"),this.links.length<=0)return null;Array.prototype.forEach.call(this.links,this._handleLink)}},{key:"_initWindowPopStateHandler",value:function(){var t=this;window.onpopstate=function(){t._prevOldLink&&(t._isBack=!0,t._getContent(t._prevOldLink))}}},{key:"_isDisableAjax",value:function(t,n){return 0<=n.indexOf("#")||n.indexOf(this._hostName)<0||t.getAttribute(this.options.disableAttribute)}},{key:"_handleLink",value:function(t){var n=t.href;if(this._isDisableAjax(t,n))return null;t.addEventListener("click",this._handleLinkClick)}},{key:"_handleLinkClick",value:function(t){t.preventDefault();var n=t.currentTarget.href;if(this._lastOldLink===n)return null;this._getContent(n)}},{key:"_getContent",value:function(t){var n,e,i,s;this._eventBus.emit("request.start"),n=t,e=this._getContentSuccess,i=this._getContentFail,(s=new XMLHttpRequest).addEventListener("load",function(){200<=s.status&&s.status<400?o(e)?e(s.responseText,n):a("callback for request is not a function"):404==s.status&&(o(i)?i(n):a("fail callback for request is not a function"))}),s.onerror=function(){o(i)?i(n):a("fail callback for request is not a function")},s.open("GET",n,!0),s.send()}},{key:"_getContentSuccess",value:function(t,n){this._eventBus.emit("request.success"),this.options.scrollToTop&&window.scrollTo(0,0);var e=this._getContentFragment(t);if(!e)return null;this._dom.containerToInsert.innerHTML=e.innerHTML,this.options.saveBack&&window.history.pushState(null,null,n),this._isBack?this.oldLinks.pop():this.oldLinks.push(n),this._initLinks(),this._eventBus.emit("content.inserted"),this._isBack=!1}},{key:"_getContentFail",value:function(){this._eventBus.emit("request.fail")}},{key:"_getContentFragment",value:function(t){var n=document.createElement("html");return n.innerHTML=t,n.querySelector(this.options.containerToInsert)}},{key:"_lastOldLink",get:function(){return 0<this.oldLinks.length&&this.oldLinks[this.oldLinks.length-1]}},{key:"_prevOldLink",get:function(){return 0<this.oldLinks.length&&this.oldLinks[this.oldLinks.length-2]}}]),n}()});
